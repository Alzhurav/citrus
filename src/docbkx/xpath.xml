<?xml version="1.0" encoding="UTF-8"?>
<chapter id="xpath">
    <title>Using XPath</title>

    <para>Some time ago in this document we have seen how XML elements are manipulated using XPath expressions 
    when sending and receiving messages. Now using XPath might raise some problems regarding namespaces that we
    want to deal with now.</para> 
    
    <para>XPath is a very powerful technology for walking XML trees. This W3C standard stands for advanced
    XML tree handling using a special syntax as query language. The test framework supports this XPath
    syntax in the following fields:</para>
    
    <itemizedlist mark="opencircle">
        <listitem>
            <para>&lt;message&gt;&lt;element path="[XPath-Expression]"&gt;&lt;/message&gt;</para>
        </listitem>
        <listitem>
            <para>&lt;validate&gt;&lt;xpath expression="[XPath-Expression]"/&gt;&lt;/validate&gt;</para>
        </listitem>
        <listitem>
            <para>&lt;extract&gt;&lt;message path="[XPath-Expression]"&gt;&lt;/extract&gt;</para>
        </listitem>
        <listitem>
            <para>&lt;ignore path="[XPath-Expression]"/&gt;</para>
        </listitem>
    </itemizedlist>
    
    <para>The next program listing indicates the power in using XPath with Citrus:</para>
    
    <programlisting>&lt;message&gt;
  &lt;validate&gt;
    &lt;xpath expression=&quot;//User/Name&quot; value=&quot;John&quot;/&gt;
    &lt;xpath expression=&quot;//User/Address[@type='office']/Street&quot; value=&quot;Companystreet 21&quot;/&gt;
    &lt;xpath expression=&quot;//User/Name&quot; value=&quot;${userName}&quot;/&gt;
    &lt;xpath expression=&quot;//User/@isAdmin&quot; value=&quot;${isAdmin}&quot;/&gt;
    &lt;xpath expression=&quot;//*[.='search-for']&quot; value=&quot;searched-for&quot;/&gt;
  &lt;/validate&gt;
&lt;/message&gt;</programlisting>
    
    <section id="xpath-namespace">
        <title>Handling XML namespaces</title>
        
        <para>When it comes to XML namespaces you have to be careful with your XPath expressions. Lets have a look at an example
        message that uses XML namespaces:</para>
      
        <programlisting>&lt;ns1:TestMessage xmlns:ns1=&quot;http://citrus.com/namespace&quot;&gt;
    &lt;ns1:TestHeader&gt;
        &lt;ns1:CorrelationId&gt;_&lt;/ns1:CorrelationId&gt;
        &lt;ns1:Timestamp&gt;2001-12-17T09:30:47.0Z&lt;/ns1:Timestamp&gt;
        &lt;ns1:VersionId&gt;2&lt;/ns1:VersionId&gt;
    &lt;/ns1:TestHeader&gt;
    &lt;ns1:TestBody&gt;
        &lt;ns1:Customer&gt;
            &lt;ns1:Id&gt;1&lt;/ns1:Id&gt;
        &lt;/ns1:Customer&gt;
    &lt;/ns1:TestBody&gt;
&lt;/ns1:TestMessage&gt;</programlisting>
        
        <para>Now we would like to validate some elements in this message using XPath</para>
        
        <programlisting>&lt;message&gt;
  &lt;validate&gt;
    &lt;xpath expression=&quot;//TestMessage/TestHeader/VersionId&quot; value=&quot;2&quot;/&gt;
    &lt;xpath expression=&quot;//TestMessage/TestHeader/CorrelationId&quot; value=&quot;${correlationId}&quot;/&gt;
  &lt;/validate&gt;
&lt;/message&gt;</programlisting>
        
        <para>The validation will fail although the XPath expression looks correct regarding the XML tree. Because the message 
        uses the namespace <literal>xmlns:ns1=&quot;http://citrus.com/namespace&quot;</literal> with its prefix <literal>ns1</literal>
        our XPath expression is not able to find the elements. The correct XPath expression uses the namespace prefix as defined 
        in the message.</para>
        
        <programlisting>&lt;message&gt;
  &lt;validate&gt;
    &lt;xpath expression=&quot;//ns1:TestMessage/ns1:TestHeader/ns1:VersionId&quot; value=&quot;2&quot;/&gt;
    &lt;xpath expression=&quot;//ns1:TestMessage/ns1:TestHeader/ns1:CorrelationId&quot; value=&quot;${correlationId}&quot;/&gt;
&lt;/message&gt;</programlisting>
        
        <para>Now the expressions work fine and the validation is successful. But this is quite error prone. This is because the test is now 
        depending on the namespace prefix that is used by some application. As soon as the message is sent with a different namespace prefix (e.g.
        ns2) the validation will fail again.</para>
        
        <para>You can avoid this effect when specifying your own namespace context and your own namespace prefix during validation.</para>
        
        <programlisting>&lt;message&gt;
  &lt;validate&gt;
    &lt;xpath expression=&quot;//pfx:TestMessage/pfx:TestHeader/pfx:VersionId&quot; value=&quot;2&quot;/&gt;
    &lt;xpath expression=&quot;//pfx:TestMessage/pfx:TestHeader/pfx:CorrelationId&quot; value=&quot;${correlationId}&quot;/&gt;
    &lt;namespace prefix=&quot;pfx&quot; value=&quot;http://citrus.com/namespace&quot;/&gt;
  &lt;/validate&gt;
&lt;/message&gt;</programlisting>
        
        <para>Now the test in independent from any namespace prefix in the received message. The namespace context will resolve the namespaces and
        find the elements although the message might use different prefixes. The only thing that matters is that the namespace value 
        (http://citrus.com/namespace) matches.</para>
        
        <tip>
            <para>Instead of this namespace context on validation level you can also have a global namespace context which is valid in all test cases.
            We just add a bean in the basic citrus-context configuration which defines global namespace mappings.</para>
            
            <programlisting>&lt;namespace-context&gt;
    &lt;namespace prefix=&quot;def&quot; uri=&quot;http://www.consol.de/samples/sayHello&quot;/&gt;
&lt;/namespace-context&gt;</programlisting>

            <para>Once defined the <emphasis>def</emphasis> namespace prefix is valid in all test cases and all XPath expressions. This enables you to free
            your test cases from namespace prefix bindings that might be broken with time. You can use these global namespace mappings wherever XPath 
            expressions are valid inside a test case (validation, ignore, extract).</para>
        </tip>
    </section>
    
    <section id="xpath-default-namespaces">
        <title>Handling default namespaces</title>
        
        <para>In the previous section we have seen that XML namespaces can get tricky with XPath validation. Default namespaces can do 
        even more! So lets look at the example with default namespaces:</para>
        
        <programlisting>&lt;TestMessage xmlns=&quot;http://citrus.com/namespace&quot;&gt;
    &lt;TestHeader&gt;
        &lt;CorrelationId&gt;_&lt;/CorrelationId&gt;
        &lt;Timestamp&gt;2001-12-17T09:30:47.0Z&lt;/Timestamp&gt;
        &lt;VersionId&gt;2&lt;/VersionId&gt;
    &lt;/TestHeader&gt;
    &lt;TestBody&gt;
        &lt;Customer&gt;
            &lt;Id&gt;1&lt;/Id&gt;
        &lt;/Customer&gt;
    &lt;/TestBody&gt;
&lt;/TestMessage&gt;</programlisting>
        
        <para>The message uses default namespaces. The following approach in XPath will fail due to namespace problems.</para>
        
        <programlisting>&lt;message&gt;
  &lt;validate&gt;
    &lt;xpath expression=&quot;//TestMessage/TestHeader/VersionId&quot; value=&quot;2&quot;/&gt;
    &lt;xpath expression=&quot;//TestMessage/TestHeader/CorrelationId&quot; value=&quot;${correlationId}&quot;/&gt;
  &lt;/validate&gt;
&lt;/message&gt;</programlisting>

        <para>Even default namespaces need to be specified in the XPath expressions. Look at the following code listing that
        works fine with default namespaces:</para>
        
        <programlisting>&lt;message&gt;
  &lt;validate&gt;
    &lt;xpath expression=&quot;//:TestMessage/:TestHeader/:VersionId&quot; value=&quot;2&quot;/&gt;
    &lt;xpath expression=&quot;//:TestMessage/:TestHeader/:CorrelationId&quot; value=&quot;${correlationId}&quot;/&gt;
  &lt;/validate&gt;
&lt;/message&gt;</programlisting>
        
        <tip>
            <para>It is recommended to use the namespace context as described in the previous chapter when validating. Only this approach
            ensures flexibility and stable test cases regarding namespace changes.</para>
        </tip>
    </section>
</chapter>