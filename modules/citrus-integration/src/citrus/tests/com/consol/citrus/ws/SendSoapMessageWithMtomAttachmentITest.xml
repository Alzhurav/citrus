<?xml version="1.0" encoding="UTF-8"?>
<spring:beans xmlns="http://www.citrusframework.org/schema/testcase" 
              xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:ws="http://www.citrusframework.org/schema/ws/testcase" 
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
              xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd 
                                  http://www.citrusframework.org/schema/testcase http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
                                  http://www.citrusframework.org/schema/ws/testcase http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd">
    <testcase name="SendSoapMessageWithMtomAttachmentITest">
        <meta-info>
            <author>Reinhard Steiner</author>
            <creationdate>2015-01-12</creationdate>
            <status>FINAL</status>
        </meta-info>
        
        <description>Sending SOAP messages with mtom attachments</description>
        
        <variables>
            <variable name="test" value="This string should not be inserted into binary SOAP attachments"/>
            <variable name="imageFile" value="classpath:com/consol/citrus/ws/soapImage.txt"/>
            <variable name="iconFile" value="classpath:com/consol/citrus/ws/soapIcon.txt"/>
        </variables>
        
        <actions>

            <echo>
                <message>Test: sending single mtom attachment</message>
            </echo>

            <parallel>
            	<ws:send endpoint="SampleSoapClient" mtom-enabled="true">
                    <message>
                        <data>
                            <![CDATA[
                                <bookStore:addBookImage xmlns:bookStore="http://www.citrusframework.org/bookstore/">
                                    <isbn>1234</isbn>
                                    <image>cid:IMAGE</image>
                                    <icon></icon>
                                </bookStore:addBookImage>
                            ]]>
                        </data>
                    </message>
                    <ws:attachment content-id="IMAGE" content-type="application/octet-stream">
                        <ws:resource file="${imageFile}"/>
                    </ws:attachment>
                </ws:send>
                                
                <sequential>
                    <ws:receive endpoint="SampleSoapServer">
                        <message schema-validation="false">
                            <data>
                                <![CDATA[
                                    <bookStore:addBookImage xmlns:bookStore="http://www.citrusframework.org/bookstore/">
                                        <isbn>1234</isbn>
                                        <image><xop:Include xmlns:xop="http://www.w3.org/2004/08/xop/include" href="cid:IMAGE"/></image>
                                        <icon></icon>
                                    </bookStore:addBookImage>
                                ]]>
                            </data>
                        </message>
                        <ws:attachment content-id="IMAGE" content-type="application/octet-stream">
                            <ws:resource file="${imageFile}"/>
                        </ws:attachment>
                    </ws:receive>
                    
                    <ws:send endpoint="SampleSoapServer">
                        <message>
                            <data>
                                <![CDATA[
                                    <bookStore:addBookImageResponse xmlns:bookStore="http://www.citrusframework.org/bookstore/">
                                        <success>true</success>
                                    </bookStore:addBookImageResponse>
                                ]]>
                            </data>
                        </message>
                    </ws:send>
                </sequential>
            </parallel>
            
            <ws:receive endpoint="SampleSoapClient">
                <message schema-repository="bookStoreSchemaRepository">
                    <data>
                        <![CDATA[
                            <bookStore:addBookImageResponse xmlns:bookStore="http://www.citrusframework.org/bookstore/">
                                <success>true</success>
                            </bookStore:addBookImageResponse>
                        ]]>
                    </data>
                </message>
            </ws:receive>
                        
            <echo>
                <message>Test: sending two mtom attachments</message>
            </echo>

            <parallel>
            	<ws:send endpoint="SampleSoapClient" mtom-enabled="true">
                    <message>
                        <data>
                            <![CDATA[
                                <bookStore:addBookImage xmlns:bookStore="http://www.citrusframework.org/bookstore/">
                                    <isbn>1234</isbn>
                                    <image>cid:IMAGE</image>
                                    <icon>cid:ICON</icon>
                                </bookStore:addBookImage>
                            ]]>
                        </data>
                    </message>
                    <ws:attachment content-id="IMAGE" content-type="application/octet-stream">
                        <ws:resource file="${imageFile}"/>
                    </ws:attachment>
                    <ws:attachment content-id="ICON" content-type="application/octet-stream">
                        <ws:resource file="${iconFile}"/>
                    </ws:attachment>
                </ws:send>
                                
                <sequential>
                    <ws:receive endpoint="SampleSoapServer">
                        <message schema-validation="false">
                            <data>
                                <![CDATA[
                                    <bookStore:addBookImage xmlns:bookStore="http://www.citrusframework.org/bookstore/">
                                        <isbn>1234</isbn>
                                        <image><xop:Include xmlns:xop="http://www.w3.org/2004/08/xop/include" href="cid:IMAGE"/></image>
                                        <icon><xop:Include xmlns:xop="http://www.w3.org/2004/08/xop/include" href="cid:ICON"/></icon>
                                    </bookStore:addBookImage>
                                ]]>
                            </data>
                        </message>
                        <ws:attachment content-id="IMAGE" content-type="application/octet-stream">
                            <ws:resource file="${imageFile}"/>
                        </ws:attachment>
                        <ws:attachment content-id="ICON" content-type="application/octet-stream">
                            <ws:resource file="${iconFile}"/>
                        </ws:attachment>
                    </ws:receive>
                    
                    <ws:send endpoint="SampleSoapServer">
                        <message>
                            <data>
                                <![CDATA[
                                    <bookStore:addBookImageResponse xmlns:bookStore="http://www.citrusframework.org/bookstore/">
                                        <success>true</success>
                                    </bookStore:addBookImageResponse>
                                ]]>
                            </data>
                        </message>
                    </ws:send>
                </sequential>
            </parallel>
            
            <ws:receive endpoint="SampleSoapClient">
                <message schema-repository="bookStoreSchemaRepository">
                    <data>
                        <![CDATA[
                            <bookStore:addBookImageResponse xmlns:bookStore="http://www.citrusframework.org/bookstore/">
                                <success>true</success>
                            </bookStore:addBookImageResponse>
                        ]]>
                    </data>
                </message>
            </ws:receive>

            <echo>
                <message>Test: sending two mtom inline attachments</message>
            </echo>

            <parallel>
            	<ws:send endpoint="SampleSoapClient" mtom-enabled="true">
                    <message>
                        <data>
                            <![CDATA[
                                <bookStore:addBookImage xmlns:bookStore="http://www.citrusframework.org/bookstore/">
                                    <isbn>1234</isbn>
                                    <image>cid:IMAGE</image>
                                    <icon>cid:ICON</icon>
                                </bookStore:addBookImage>
                            ]]>
                        </data>
                    </message>
                    <ws:attachment content-id="IMAGE" content-type="application/octet-stream" mtom-inline="true" encoding-type="base64Binary">
                        <ws:resource file="${imageFile}"/>
                    </ws:attachment>
                    <ws:attachment content-id="ICON" content-type="application/octet-stream" mtom-inline="true" encoding-type="hexBinary">
                        <ws:resource file="${iconFile}"/>
                    </ws:attachment>
                </ws:send>
                
                <sequential>
                    <ws:receive endpoint="SampleSoapServer">
                        <message schema-repository="bookStoreSchemaRepository">
                            <data>
                                <![CDATA[
                                    <bookStore:addBookImage xmlns:bookStore="http://www.citrusframework.org/bookstore/">
                                        <isbn>1234</isbn>
                                        <image>VGhpcyBpcyBhIGJpbmFyeSBpbWFnZSBhdHRhY2htZW50IQpWYXJpYWJsZXMgJXt0ZXN0fSBzaG91bGQgbm90IGJlIHJlcGxhY2VkIQ==</image>
                                        <icon>5468697320697320612062696E6172792069636F6E206174746163686D656E74210A5661726961626C657320257B746573747D2073686F756C64206E6F74206265207265706C6163656421</icon>
                                    </bookStore:addBookImage>
                                ]]>
                            </data>
                        </message>
                    </ws:receive>
                    
                    <ws:send endpoint="SampleSoapServer">
                        <message>
                            <data>
                                <![CDATA[
                                    <bookStore:addBookImageResponse xmlns:bookStore="http://www.citrusframework.org/bookstore/">
                                        <success>true</success>
                                    </bookStore:addBookImageResponse>
                                ]]>
                            </data>
                        </message>
                    </ws:send>
                </sequential>
            </parallel>
            
            <ws:receive endpoint="SampleSoapClient">
                <message schema-repository="bookStoreSchemaRepository">
                    <data>
                        <![CDATA[
                            <bookStore:addBookImageResponse xmlns:bookStore="http://www.citrusframework.org/bookstore/">
                                <success>true</success>
                            </bookStore:addBookImageResponse>
                        ]]>
                    </data>
                </message>
            </ws:receive>
        </actions>
    </testcase>
</spring:beans>